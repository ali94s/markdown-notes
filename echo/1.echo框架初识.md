## ä¸€ã€echoæ¡†æ¶åˆè¯†

echoæ¡†æ¶ç”Ÿå‘½å‘¨æœŸï¼ˆæ‘˜è‡ªç½‘ä¸Šï¼‰ï¼Œå›¾ç‰‡å¯ä»¥åœ¨æµè§ˆå™¨ä¸Šæ‰“å¼€æŸ¥çœ‹

![img](http://cdn.tigerb.cn/20190711122919.png)

## å…³é”®ä»£ç è§£æ

```
// åˆå§‹åŒ–ä¸€ä¸ªechoæ¡†æ¶å®ä¾‹
// ä¸åŒäºiriså’Œgin 
// iriså’Œginåœ¨è¿™ä¹‹ä¸Šåˆå°è£…äº†ä¸€å±‚ åŒ…å«å¿…é¡»çš„ä¸­é—´ä»¶æ³¨å†Œ
e := echo.New()
â¬‡ï¸
// å…·ä½“çš„è·å–å®ä¾‹æ–¹æ³•
func New() (e *Echo) {
	e = &Echo{
		// åˆ›å»ºä¸€ä¸ªhttp ServeræŒ‡é’ˆ
		Server:    new(http.Server),
		// åˆ›å»ºä¸€ä¸ªhttpsçš„ ServeræŒ‡é’ˆ
		TLSServer: new(http.Server),
		AutoTLSManager: autocert.Manager{
			Prompt: autocert.AcceptTOS,
		},
		// æ—¥å¿—å®ä¾‹
		Logger:   log.New("echo"),
		// æ§åˆ¶å°ã€æ—¥å¿—å¯ä»¥å½©è‰²è¾“å‡ºçš„å®ä¾‹
		colorer:  color.New(),
		maxParam: new(int),
	}
	// http serverç»‘å®šå®ç°äº†server.Handlerçš„å®ä¾‹
	// ä¹Ÿå°±æ˜¯è¯´Echoæ¡†æ¶è‡ªèº«å®ç°äº†http.Handleræ¥å£
	e.Server.Handler = e
	// https serverç»‘å®šå®ç°äº†server.Handlerçš„å®ä¾‹
	e.TLSServer.Handler = e
	// ç»‘å®šhttpæœåŠ¡å¼‚å¸¸å¤„ç†çš„handler
	e.HTTPErrorHandler = e.DefaultHTTPErrorHandler
	// 
	e.Binder = &DefaultBinder{}
	// è®¾ç½®æ—¥å¿—è¾“å‡ºçº§åˆ«
	e.Logger.SetLevel(log.ERROR)
	// ç»‘å®šæ ‡å‡†æ—¥å¿—è¾“å‡ºå®ä¾‹
	e.StdLogger = stdLog.New(e.Logger.Output(), e.Logger.Prefix()+": ", 0)
	// å’Œirisã€ginéƒ½ä¸€æ ·
	// ç»‘å®šè·å–è¯·æ±‚ä¸Šä¸‹æ–‡å®ä¾‹çš„é—­åŒ…
	e.pool.New = func() interface{} {
		return e.NewContext(nil, nil)
	}
	// ç»‘å®šè·¯ç”±å®ä¾‹
	e.router = NewRouter(e)
	// ç»‘å®šè·¯ç”±map
	// æ³¨æ„è¿™ä¸ªå±æ€§çš„å«ä¹‰ï¼šè·¯ç”±åˆ†ç»„ç”¨çš„ï¼Œkeyä¸ºhost,åˆ™æŒ‰hoståˆ†ç»„
	// è®°ä½ä¸Router.routesåŒºåˆ«
	// Router.routeså­˜çš„è·¯ç”±çš„ä¿¡æ¯(ä¸åŒ…å«è·¯ç”±çš„handler)
	e.routers = map[string]*Router{}
	return
}
â¬‡ï¸
func NewRouter(e *Echo) *Router {
	// åˆå§‹åŒ–Router
	return &Router{
		// è·¯ç”±æ ‘
		// è·¯ç”±çš„ä¿¡æ¯(åŒ…å«è·¯ç”±çš„handler)
		// æŸ¥æ‰¾è·¯ç”±ç”¨çš„LCP (æœ€é•¿å…¬å…±å‰ç¼€)ç®—æ³•
		tree: &node{
			// èŠ‚ç‚¹å¯¹åº”çš„ä¸åŒhttp methodçš„handler
			methodHandler: new(methodHandler),
		},
		// Router.routeså­˜çš„è·¯ç”±çš„ä¿¡æ¯(ä¸åŒ…å«è·¯ç”±çš„handler)
		routes: map[string]*Route{},
		// æ¡†æ¶å®ä¾‹è‡ªèº«
		echo:   e,
	}
}

// ---------router---------
// æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹è·¯ç”±ç›¸å…³çš„æµç¨‹
// ä¹‹å‰æˆ‘ä»¬å…ˆçœ‹çœ‹ç›¸å…³ä¸€äº›é‡è¦çš„ç»“æ„ä½“
Router struct {
	// è·¯ç”±æ ‘
	tree   *node
	// è·¯ç”±ä¿¡æ¯
	routes map[string]*Route
	// æ¡†æ¶å®ä¾‹
    echo   *Echo
}

// LCP (æœ€é•¿å…¬å…±å‰ç¼€) ç®—æ³• é€šè¿‡pathæŸ¥æ‰¾è·¯ç”±
node struct {
    kind          kind
    label         byte
    prefix        string
    parent        *node
    children      children
    ppath         string
    pnames        []string
    methodHandler *methodHandler
}
kind          uint8
// å­èŠ‚ç‚¹
children      []*node
// ä¸åŒhttp methodçš„handler
methodHandler struct {
    connect  HandlerFunc
    delete   HandlerFunc
    get      HandlerFunc
    head     HandlerFunc
    options  HandlerFunc
    patch    HandlerFunc
    post     HandlerFunc
    propfind HandlerFunc
    put      HandlerFunc
    trace    HandlerFunc
    report   HandlerFunc
}
HandlerFunc func(Context) error

Route struct {
	// http method
	Method string `json:"method"`
	// è·¯ç”±path
	Path   string `json:"path"`
	// è·¯ç”±handleråç§°
    Name   string `json:"name"`
}

// æ³¨å†Œè·¯ç”±
e.GET("/", hello)
â¬‡ï¸
// æ³¨å†Œè·¯ç”±
func (e *Echo) GET(path string, h HandlerFunc, m ...MiddlewareFunc) *Route {
	// æ³¨å†Œè·¯ç”±
	return e.Add(http.MethodGet, path, h, m...)
}
ï¸ï¸â¬‡ï¸
func (e *Echo) Add(method, path string, handler HandlerFunc, middleware ...MiddlewareFunc) *Route {
	// æ³¨å†Œè·¯ç”± addæ–¹æ³•ç›¸å¯¹äºAddå¤šäº†hostå‚æ•°
	return e.add("", method, path, handler, middleware...)
}
â¬‡ï¸
func (e *Echo) add(host, method, path string, handler HandlerFunc, middleware ...MiddlewareFunc) *Route {
	// è·å–handlerçš„åç§°
	// ğŸ˜¨è¿™ä¸ªæ–¹æ³•é‡Œé¢å°½ç„¶ç”¨äº†åå°„è·å–name åªæ˜¯ä¸ªnameæœ‰å¿…è¦ä¹ˆ æ²¡åˆ«çš„åŠæ³•äº†å—ï¼Ÿ
	name := handlerName(handler)
	// å¯»æ‰¾å½“å‰hostçš„è·¯ç”±å®ä¾‹
	router := e.findRouter(host)
	// æ³¨å†Œè·¯ç”±
	// æ³¨æ„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸ªé—­åŒ… åŒ¹é…åˆ°è·¯ç”±å°±ä¼šæ‰§è¡Œè¿™ä¸ªé—­åŒ…
	router.Add(method, path, func(c Context) error {
		// åˆå§‹åŒ–ä¸€ä¸ªhandlerç±»å‹çš„å®ä¾‹
		h := handler
		for i := len(middleware) - 1; i >= 0; i-- {
			// æ³¨æ„è¿™é‡Œçš„ä¸­é—´ä»¶æ˜¯è¿™ä¸ªè·¯ç”±ä¸“å±çš„
			// è€ŒUseã€Preæ³¨å†Œçš„ä¸­é—´ä»¶æ˜¯å…¨å±€å…¬å…±çš„
			// éå†ä¸­é—´ä»¶
			// æ³¨æ„è¿”å›å€¼ç±»å‹æ˜¯HandlerFunc
			// æ„Ÿè§‰ä»–ä»¬è¿™é‡Œè®¾è®¡çš„å¤æ‚äº†
			// åæœŸæˆ‘çœ‹çœ‹å¯ä¸å¯ä»¥æŠŠè´£ä»»é“¾æ¨¡å¼å¼•å…¥è¿›æ¥ ä¸€ä¸‹å°±æ¸…æ™°äº†
			h = middleware[i](h)
		}
		// æ‰§è¡Œæœ€åä¸€ä¸ªä¸­é—´ä»¶
		return h(c)
	})
	// æœ¬æ¬¡æ³¨å†Œè¿›æ¥çš„è·¯ç”±çš„ä¿¡æ¯
	// æ„Ÿè§‰è®¾è®¡çš„å¾ˆæ€ª ä¸Šé¢æ³¨å†Œä¸€æ¬¡è·¯ç”±ä¸”åŒ…å«è·¯ç”±çš„handler
	// è¿™é‡Œåˆå•ç‹¬å­˜ä¸€ä¸ªä¸åŒ…å«è·¯ç”±handlerçš„è·¯ç”±ä¿¡æ¯
	// ä¸ºå•¥ä¸éƒ½æ”¾ä¸€èµ·å‘¢ï¼Ÿå“
	r := &Route{
		Method: method,
		Path:   path,
		Name:   name,
	}
	// mapå­˜è·¯ç”±ä¿¡æ¯
	e.router.routes[method+path] = r
	return r
}

// ---------start---------
// å¯åŠ¨http server
e.Start(":1323")

func (e *Echo) Start(address string) error {
	// è®¾ç½®serveråœ°å€
	e.Server.Addr = address
	// å¯åŠ¨server
	return e.StartServer(e.Server)
}
â¬‡ï¸
func (e *Echo) StartServer(s *http.Server) (err error) {
	e.colorer.SetOutput(e.Logger.Output())
	s.ErrorLog = e.StdLogger
	// è®¾ç½®æ¡†æ¶å®ä¾‹åˆ°http serverçš„Handler
	// Echoæ¡†æ¶ç»“æ„ä½“å®ç°äº†http.Handleræ¥å£
	s.Handler = e
	if e.Debug {
		// å¦‚æœå¼€å¯äº†debugåˆ™è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º debug
		e.Logger.SetLevel(log.DEBUG)
	}

	// æ˜¯å¦éšè—æ¡†æ¶å¯åŠ¨è¾“å‡ºçš„æ ‡å¿—
	if !e.HideBanner {
		e.colorer.Printf(banner, e.colorer.Red("v"+Version), e.colorer.Blue(website))
	}

	// å¯åŠ¨http server
	if s.TLSConfig == nil {
		if e.Listener == nil {
			// ç›‘å¬ip+port
			e.Listener, err = newListener(s.Addr)
			if err != nil {
				return err
			}
		}
		// æ‰“å°æœåŠ¡åœ°å€
		if !e.HidePort {
			e.colorer.Printf("â‡¨ http server started on %s\n", e.colorer.Green(e.Listener.Addr()))
		}
		return s.Serve(e.Listener)
	}
	// å¯åŠ¨https server
	if e.TLSListener == nil {
		l, err := newListener(s.Addr)
		if err != nil {
			return err
		}
		// ç›‘å¬ip+port
		// è®¾ç½®httpsé…ç½®
		e.TLSListener = tls.NewListener(l, s.TLSConfig)
	}
	if !e.HidePort {
		// æ‰“å°æœåŠ¡åœ°å€
		e.colorer.Printf("â‡¨ https server started on %s\n", e.colorer.Green(e.TLSListener.Addr()))
	}
	return s.Serve(e.TLSListener)
}
â¬‡ï¸
s.Serve()
â¬‡ï¸
// acceptç½‘ç»œè¯·æ±‚
rw, e := l.Accept()
â¬‡ï¸
// goroutineå¤„ç†è¯·æ±‚
go c.serve(ctx)
â¬‡ï¸
// æ‰§è¡ŒserverHandlerçš„ServeHTTP
serverHandler{c.server}.ServeHTTP(w, w.req)
â¬‡ï¸
// æ‰§è¡Œå½“å‰æ¡†æ¶å®ä¾‹çš„ServeHTTPæ–¹æ³•
handler.ServeHTTP(rw, req)
â¬‡ï¸
func (e *Echo) ServeHTTP(w http.ResponseWriter, r *http.Request) {
	// è·å–ä¸Šä¸‹æ–‡å®ä¾‹
	c := e.pool.Get().(*context)
	// é‡ç½®ä¸Šä¸‹æ–‡
	c.Reset(r, w)

	// é»˜è®¤handler
	h := NotFoundHandler

	// ä¸å­˜åœ¨é¢„æ‰§è¡Œä¸­é—´ä»¶æ—¶
	// è¯´è¯´è¿™ä¸ªé¢„æ‰§è¡Œä¸­é—´ä»¶çš„å«ä¹‰ï¼š
	// çœ‹æºç æ³¨é‡Šçš„å«ä¹‰æ˜¯åœ¨å¯»æ‰¾åˆ°è·¯ç”±ä¹‹å‰æ‰§è¡Œçš„ä¸­é—´ä»¶
	// ç®€å•æ¥è¯´å’Œæ™®é€šä¸­é—´ä»¶çš„çš„åŒºåˆ«å°±æ˜¯ï¼Œè¿˜æ²¡èµ°åˆ°åŒ¹é…è·¯ç”±çš„é€»è¾‘å°±ä¼šæ‰§è¡Œçš„ä¸­é—´ä»¶ï¼Œä»ä¸‹é¢æ¥çœ‹åªæ˜¯ä»£ç é€»è¾‘çš„åŒºåˆ«ï¼Œå®é™…çš„ä¸­é—´ä»¶æ‰§è¡Œé¡ºåºè¿˜æ˜¯è°å…ˆæ³¨å†Œè°å…ˆæ‰§è¡Œã€‚æ‰€ä»¥æ— è®ºæ˜¯å­˜åœ¨æ™®é€šä¸­é—´ä»¶è¿˜æ˜¯é¢„æ‰§è¡Œä¸­é—´ä»¶ï¼Œè·¯ç”±çš„handleæ€»æ˜¯æœ€åæ‰§è¡Œã€‚
	// ä¸ªäººæ„Ÿè§‰é¢„æ‰§è¡Œä¸­é—´ä»¶çš„æ„ä¹‰ä¸å¤§
	if e.premiddleware == nil {
		// å…ˆæ‰¾å½“å‰hostç»„çš„router
		// LCPç®—æ³•å¯»æ‰¾å½“å‰pathçš„handler
		e.findRouter(r.Host).Find(r.Method, getPath(r), c)
		// æ‰¾åˆ°å½“å‰è·¯ç”±çš„handler
		h = c.Handler()
		// æ„æˆä¸­é—´ä»¶é“¾
		h = applyMiddleware(h, e.middleware...)
	} else {
		// çœ‹è§è¿™ä¸ªé¢„æ‰§è¡Œä¸­é—´ä»¶çš„åŒºåˆ«äº†å§
		// æŠŠæ³¨å†Œæ™®é€šä¸­é—´ä»¶çš„é€»è¾‘åˆåŒ…è£…æˆäº†ä¸€ä¸ªHandlerFuncæ³¨å†Œåˆ°ä¸­é—´ä»¶é“¾ä¸­
		h = func(c Context) error {
			// å…ˆæ‰¾å½“å‰hostç»„çš„router
			// LCPç®—æ³•å¯»æ‰¾å½“å‰pathçš„handler
			e.findRouter(r.Host).Find(r.Method, getPath(r), c)
			h := c.Handler()
			h = applyMiddleware(h, e.middleware...)
			return h(c)
		}
		// æ„æˆä¸­é—´ä»¶é“¾
		h = applyMiddleware(h, e.premiddleware...)
	}

	// æ‰§è¡Œä¸­é—´ä»¶é“¾
	// åœ¨applyMiddlewareä¸­æ‰€æœ‰ä¸­é—´ä»¶æ„æˆäº†ä¸€ä¸ªé“¾
	if err := h(c); err != nil {
		e.HTTPErrorHandler(err, c)
	}

	// é‡Šæ”¾ä¸Šä¸‹æ–‡
	e.pool.Put(c)
}

// æ„æˆä¸­é—´ä»¶é“¾
// åœ¨æ„å»ºè¿™ä¸ªä¸­é—´ä»¶é“¾çš„ç»†èŠ‚æ–¹å¼ä¸Š å’Œiris,ginè¿˜æ˜¯ä¸ä¸€æ · 
// åç»­ä¸“å†™ä¸€ç¯‡æ–‡ç« è¯¦ç»†å¯¹æ¯”å„æ¡†æ¶ä¸­é—´ä»¶çš„å®ç°
func applyMiddleware(h HandlerFunc, middleware ...MiddlewareFunc) HandlerFunc {
	for i := len(middleware) - 1; i >= 0; i-- {
		// æ³¨æ„è¿™é‡Œè¿”å›çš„è¿˜æ˜¯ä¸€ä¸ªé—­åŒ…
		// æ‰€ä»¥è¯´è¿˜æ²¡çœŸæ­£æ‰§è¡Œ
		h = middleware[i](h)
	}
	return h
}

// ---------log---------
// è®°å½•å¯åŠ¨é”™è¯¯æ—¥å¿—
e.Logger.Fatal()
```

## æµç¨‹

![img](http://cdn.tigerb.cn/20190711125947.png)